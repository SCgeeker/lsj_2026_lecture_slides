---
title: "W13：類別資料分析——卡方檢定"
subtitle: "基礎統計學 2026"
author: "慈濟大學"
date: "`r Sys.Date()`"
output:
  revealjs::revealjs_presentation:
    theme: simple
    highlight: pygments
    center: false
    transition: slide
    self_contained: true
    css: custom.css
    reveal_options:
      slideNumber: true
      previewLinks: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 9, fig.height = 5)
library(ggplot2)
library(dplyr)

# ===== randomness 資料：適合度檢定示範 =====
# 電子書第 10 章：骰子公平性 (Ch10 隨機性檢定)
# 300 次擲骰結果
set.seed(2026)
dice_rolls <- sample(1:6, 300, replace = TRUE, prob = c(0.15, 0.15, 0.15, 0.15, 0.15, 0.25))
dice_table <- table(dice_rolls)
dice_chisq <- chisq.test(dice_table)

# ===== chapek9 資料：獨立性檢定示範 =====
# 電子書第 10 章：機器人對人類的偏好
# 模擬 180 位受試者（3 species × 2 choices）
chapek9 <- data.frame(
  species = rep(c("robot", "human", "cyborg"), each = 60),
  choice = c(
    sample(c("puppy", "flower"), 60, replace = TRUE, prob = c(0.65, 0.35)),
    sample(c("puppy", "flower"), 60, replace = TRUE, prob = c(0.50, 0.50)),
    sample(c("puppy", "flower"), 60, replace = TRUE, prob = c(0.40, 0.60))
  )
)
chapek9_table <- table(chapek9$species, chapek9$choice)
chapek9_chisq <- chisq.test(chapek9_table)
chapek9_cramersv <- sqrt(chapek9_chisq$statistic / (sum(chapek9_table) * (min(dim(chapek9_table)) - 1)))
```

# 本週學習目標

**理解概念**：

1. 理解**觀測值 vs 預期值**的概念
2. 掌握**適合度檢定**與**獨立性檢定**
3. 學會解讀 **Cramer's V** 效果量
4. 區分 **t 檢定**（比平均）vs **卡方檢定**（比比例）

---

**軟體操作**：

1. 在 jamovi 中執行 **Frequencies → N Outcomes**（適合度）
2. 在 jamovi 中執行 **Frequencies → Contingency Tables**（獨立性）
3. 勾選 Expected Counts 與 Cramer's V
4. 撰寫 APA 格式的卡方檢定報告

---

## 對應教材

- 《用 jamovi 上手統計學》
  - [第 10 章：類別資料分析](https://scgeeker.github.io/lsj-book-zh_tw/10-Categorical-data-analysis.html)

**簡報示範資料**：

- 骰子擲骰 300 次（適合度檢定）
- Chapek9：機器人 × 選擇偏好（獨立性檢定）

**作業資料**：個人化 `W13_Survey_[學號].csv`


# Part 1：觀測值與預期值

---

## 從直覺到統計

**日常直覺**：擲硬幣 100 次

- **預期**：正面 50 次、反面 50 次
- **實際**：正面 70 次、反面 30 次
- **問題**：這個差距是「運氣」還是「硬幣不公平」？

---

**卡方檢定的核心**：

$$\chi^2 = \sum \frac{(O - E)^2}{E}$$

- $O$：觀測值（Observed）— 實際看到的
- $E$：預期值（Expected）— 假設為真時的期望
- 差距越大 → $\chi^2$ 越大 → 越不像巧合

---

## 卡方分布的特性

```{r chisq-distribution, fig.height=4.5}
# 不同 df 的卡方分布曲線
x <- seq(0, 25, by = 0.1)
df_values <- c(1, 2, 4, 6, 10)

chisq_df <- data.frame()
for (df_val in df_values) {
  chisq_df <- rbind(chisq_df, data.frame(
    x = x,
    density = dchisq(x, df = df_val),
    df = factor(paste0("df = ", df_val), levels = paste0("df = ", df_values))
  ))
}

ggplot(chisq_df, aes(x = x, y = density, color = df)) +
  geom_line(size = 1.2) +
  scale_color_brewer(palette = "Set1") +
  labs(title = "卡方分布：不同自由度的形狀",
       x = expression(chi^2), y = "密度",
       color = "自由度") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "right")
```

---

## 卡方分布的關鍵特徵

| 特徵 | 說明 |
|:-----|:-----|
| 只有正值 | $\chi^2 \geq 0$（平方後不可能為負） |
| 右偏分布 | 低 df 時明顯右偏，高 df 時趨近常態 |
| df 決定形狀 | df 越大 → 分布越對稱、越往右移 |
| 平均值 = df | $E(\chi^2) = df$ |

> 與 t 分布不同：卡方**沒有負值**，且**不對稱**


# Part 2：適合度檢定

---

## 骰子公平嗎？

**情境**：擲一顆骰子 300 次，結果如下：

```{r dice-table}
dice_df <- data.frame(
  點數 = 1:6,
  觀測次數 = as.integer(dice_table),
  預期次數 = rep(300/6, 6)
)
knitr::kable(dice_df, align = "c",
             caption = "300 次觀測值 vs 預期值")
```

- **$H_0$**：骰子公平（出現任何點數機率 = 1/6）
- **$H_1$**：骰子不公平（任一種點數機率 ≠ 1/6）

---

## 觀測 vs 預期的視覺化

```{r dice-barplot, fig.height=4.5}
dice_plot_df <- data.frame(
  面 = factor(rep(1:6, 2)),
  次數 = c(as.integer(dice_table), rep(300/6, 6)),
  類型 = rep(c("觀測值", "預期值"), each = 6)
)

ggplot(dice_plot_df, aes(x = 面, y = 次數, fill = 類型)) +
  geom_col(position = "dodge", alpha = 0.8) +
  scale_fill_manual(values = c("預期值" = "#95a5a6", "觀測值" = "#3498db")) +
  labs(title = "骰子 300 次擲骰：觀測值 vs 預期值",
       x = "骰子面", y = "次數", fill = "") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "top")
```

---

## 適合度檢定結果

$$\chi^2(`r dice_chisq$parameter`) = `r round(dice_chisq$statistic, 2)`,\quad p = `r sprintf("%.3f", dice_chisq$p.value)`$$

$p = `r sprintf("%.3f", dice_chisq$p.value)` `r ifelse(dice_chisq$p.value < 0.05, "< .05", ">= .05")`$ → `r ifelse(dice_chisq$p.value < 0.05, "**拒絕 H₀**：骰子不公平", "**保留 H₀**：沒有足夠證據說骰子不公平")`

**自由度**：$df = k - 1 = 6 - 1 = `r dice_chisq$parameter`$（k 為類別數）

---

## jamovi 操作：適合度檢定

**步驟**：

1. **Frequencies → N Outcomes → $\chi^2$ Goodness of fit**
2. 將類別變項拖入 **Variable**
3. 選擇 **Expected Proportions**（預設均等）
4. 查看結果表格中的 $\chi^2$、df、p

**注意**：

- 如果預期比例不均等，需手動設定每個類別的比例
- 例如：預期 A:B:C = 2:1:1 → 輸入 0.5, 0.25, 0.25


# Part 3：獨立性檢定

---

## Chapek9 資料集

**情境**：旅客族群（robot、human、cyborg）的回答偏好（puppy 或 flower）

```{r chapek9-table}
chapek9_ct <- addmargins(chapek9_table)
knitr::kable(chapek9_ct, align = "c",
             caption = "Species × Choice 列聯表")
```

**問題**：旅客族群與回答偏好之間有關聯嗎？

- **$H_0$**：species 與 choice 獨立（無關聯）
- **$H_1$**：species 與 choice 不獨立（有關聯）

---

## 百分比堆疊條形圖

```{r chapek9-stacked, fig.height=4}
chapek9_pct <- chapek9 %>%
  count(species, choice) %>%
  group_by(species) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ungroup()

ggplot(chapek9_pct, aes(x = species, y = pct, fill = choice)) +
  geom_col(alpha = 0.85) +
  geom_text(aes(label = sprintf("%.1f%%", pct)),
            position = position_stack(vjust = 0.5), size = 4.5) +
  scale_fill_manual(values = c("flower" = "#e74c3c", "puppy" = "#3498db")) +
  labs(title = "Chapek9：各物種的選擇比例",
       x = "物種", y = "百分比 (%)", fill = "選擇") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "top")
```

> 如果三組回答比例相同 → 獨立；比例不同 → 有關聯

---

## 獨立性檢定的預期值

:::::::::::::: {.columns}
::: {.column width="50%"}

**預期值計算**：

$$E_{ij} = \frac{R_i \times C_j}{N}$$

:::
::: {.column width="50%"}


```{r chapek9-expected}
expected_df <- as.data.frame(round(chapek9_chisq$expected, 1))
knitr::kable(expected_df, align = "c",
             caption = "預期次數（假設 H₀ 為真）")
```

:::
::::::::::::::

> 預期值 = 「如果物種與選擇無關，各格子應該有多少人？」

---

## 獨立性檢定結果

$$\chi^2(`r chapek9_chisq$parameter`) = `r round(chapek9_chisq$statistic, 2)`,\quad p = `r sprintf("%.3f", chapek9_chisq$p.value)`,\quad V = `r round(as.numeric(chapek9_cramersv), 2)`$$

$p = `r sprintf("%.3f", chapek9_chisq$p.value)` `r ifelse(chapek9_chisq$p.value < 0.05, "< .05", ">= .05")`$ → `r ifelse(chapek9_chisq$p.value < 0.05, "**拒絕 H₀**：物種與選擇有關聯", "**保留 H₀**：無足夠證據顯示關聯")`

$V = `r round(as.numeric(chapek9_cramersv), 2)`$（`r ifelse(as.numeric(chapek9_cramersv) >= 0.5, "大", ifelse(as.numeric(chapek9_cramersv) >= 0.3, "中", "小"))`效果）

---

## 解讀列聯表的百分比

:::::::::::::: {.columns}
::: {.column width="50%"}

**行百分比**（Row %）

- 每一列加總 = 100%
- 回答：「在 robot 中，選 puppy 的比例是多少？」
- 用於比較**不同物種的選擇模式**

:::
::: {.column width="50%"}

**列百分比**（Column %）

- 每一欄加總 = 100%
- 回答：「在選 puppy 的人中，robot 佔多少？」
- 用於比較**不同選擇的物種組成**

:::
::::::::::::::

> jamovi 中可在 Contingency Tables 勾選 Row / Column percentages

---

## jamovi 操作：獨立性檢定

**步驟**：

1. **Frequencies → Contingency Tables → Independent Samples - $\chi^2$ test of association**

2. 將一個類別變項拖入 **Rows**，另一個拖入 **Columns**

3. 勾選 **Statistics → $\chi^2$**

4. 勾選 **Statistics → Cramer's V**（效果量）

5. 勾選 **Cells → Expected counts**

<small>
**加分選項**：Row percentages / Column percentages → 比較比例
</small>


# Part 4：效果量與適用條件

---

## Cramer's V：關聯強度


:::::::::::::: {.columns}
::: {.column width="50%"}

$$V = \sqrt{\frac{\chi^2}{N \times (k - 1)}}$$

:::
::: {.column width="50%"}

$k = \min(\text{列數}, \text{欄數})$

| Cramer's V | 關聯強度 |
|:----------:|:--------:|
| .10 | 小 |
| .30 | 中 |
| .50 | 大 |

:::
::::::::::::::

> V 的範圍：0（完全獨立）到 1（完全關聯）

---

## 適用條件：預期次數 ≥ 5

**規則**：每個細格的**預期次數** $E_{ij} \geq 5$

```{r expected-check}
expected_vals <- chapek9_chisq$expected
below5 <- sum(expected_vals < 5)

knitr::kable(round(expected_vals, 1), align = "c",
             caption = "Chapek9 的預期次數")
```

- 預期次數 < 5 的細格數：`r below5`

`r ifelse(below5 == 0, "→ **所有預期次數 ≥ 5**，卡方檢定適用 ✓", sprintf("→ **有 %d 個細格預期值 < 5**，建議使用 Fisher's Exact Test ⚠", below5))`

---

## Fisher's Exact Test

**何時使用**？

- 預期次數 < 5 的細格超過 **20%**
- 或任何一格預期次數 < 1

---

## Fisher's Exact Test(續)

**jamovi 操作**：

- Contingency Tables → Statistics → 勾選 **Fisher's exact test**

**差異**：

| | 卡方檢定 | Fisher's Exact |
|:--|:--|:--|
| 原理 | 近似法（大樣本） | 精確機率計算 |
| 適用 | 預期次數都 ≥ 5 | 小樣本或稀疏表格 |
| 結果 | $\chi^2$, df, p | 僅 p 值 |


# Part 5：t vs $\chi^2$ 快速辨識

---

## 判斷流程

```
你的依變項是什麼類型？
         │
    ┌────┴────┐
    │         │
 連續的      類別的
（分數、時間）（是/否、選擇）
    │         │
  t 檢定     卡方檢定
    │         │
    └────┬────┘
         │
   報告效果量
  (d 或 V)
```

> **核心原則**：比**平均數** → t，比**比例/次數** → $\chi^2$

---

## 情境練習

| # | 情境 | 應使用 |
|:--|:-----|:------:|
| 1 | 比較男女生的考試**分數** | **t 檢定** |
| 2 | 比較男女生選文組/理組的**人數** | **卡方檢定** |
| 3 | 比較治療前後的焦慮**量表分數** | **相依 t** |
| 4 | 調查不同年齡層偏好的飲料**類型** | **卡方檢定** |

---

## 判斷的關鍵問句

問自己兩個問題：

1. **依變項是數字（連續）還是類別？**
   - 數字 → t（或 ANOVA）
   - 類別 → $\chi^2$

2. **自變項有幾組？**
   - 1 組 vs 理論值 → 適合度 / 單一樣本 t
   - 2 組以上 → 獨立性 / 獨立樣本 t


# Part 6：本週作業

---

## 作業內容

**資料**：個人化 `W13_Survey_[學號].csv`

你的資料包含：

| 變項 | 類型 | 說明 |
|:-----|:-----|:-----|
| `Member_Type` | Nominal | 會員類型（Regular / Premium / VIP） |
| `Store_Preference` | Nominal | 商店偏好（A / B / C / D） |
| `Satisfaction` | Nominal | 滿意度（Satisfied / Neutral / Dissatisfied） |

---

## 任務 1：適合度檢定

**操作**：檢驗 `Store_Preference` 是否均等分佈

1. **Frequencies → N Outcomes**
2. 檢視 $\chi^2$、df、p 值
3. 記錄觀測次數與預期次數

---

## 任務 2：獨立性檢定

**操作**：檢驗 `Member_Type` 與 `Satisfaction` 之間是否有關聯

1. **Frequencies → Contingency Tables**
2. 勾選 **$\chi^2$** + **Cramer's V**
3. 勾選 **Expected counts**
4. 記錄列聯表與預期次數
5. 判斷是否有預期次數 < 5 的情況

---

## 任務 3：APA 寫作 + 觀念辨析

**APA 寫作**（2 段）：

1. 適合度檢定：$\chi^2(df) = \dots,\ p = \dots$
2. 獨立性檢定：$\chi^2(df) = \dots,\ p = \dots,\ V = \dots$

---

**觀念辨析**（3 題）：

1. **Q1**：請說明以下情境應使用 t 檢定還是卡方檢定，並解釋原因：

(a) 比較男生和女生的考試成績平均分數

(b) 調查中學生與大學生偏好使用的社群軟體（IG/FB/TikTok）比例

(c) 檢驗一枚硬幣是否公平（各面出現次數是否均等）

2. **Q2**：為什麼預期次數太小（< 5）會導致卡方檢定不準確？此時應如何處理？
3. **Q3**：Cramer's V = 0.15 與 V = 0.45 分別代表什麼？為什麼光看 p 值不夠？

---

## 繳交要求

**檔案 1：學號_姓名_W13_Lab.omv**

- 含適合度檢定（Store_Preference）
- 含獨立性檢定（Member_Type × Satisfaction）
- 勾選 Expected Counts 與 Cramer's V

**檔案 2：學號_姓名_W13_Report.docx**

- 適合度檢定結果
- 獨立性檢定結果 + 預期次數診斷
- 2 段 APA 格式報告
- 3 題觀念辨析

**繳交期限**：本週上課結束前


# 小結與展望

---

## 本週核心概念

1. **觀測 vs 預期**：$\chi^2 = \sum (O-E)^2 / E$
2. **適合度檢定**：一個變項的分佈是否符合預期
3. **獨立性檢定**：兩個類別變項是否有關聯
4. **效果量**：Cramer's V（.1 小 / .3 中 / .5 大）
5. **適用條件**：預期次數 ≥ 5，否則用 Fisher's Exact
6. **t vs $\chi^2$**：連續 → t，類別 → $\chi^2$

---

## 下週預告

**下週問題**：

- 兩個**連續變項**之間的關係？
- 什麼是**相關係數**？
- **相關 ≠ 因果**到底是什麼意思？

---

## 課後資源

**電子書**： [第 10 章：類別資料分析](https://scgeeker.github.io/lsj-book-zh_tw/10-Categorical-data-analysis.html)

**關鍵術語對照**：

| 中文 | 英文 | 符號 |
|:-----|:-----|:-----|
| 卡方檢定 | Chi-square test | $\chi^2$ |
| 適合度檢定 | Goodness-of-fit test | — |
| 獨立性檢定 | Test of independence | — |
| 列聯表 | Contingency table | — |
| 預期次數 | Expected frequency | $E$ |
| 觀測次數 | Observed frequency | $O$ |
| 克拉瑪 V | Cramer's V | $V$ |

---

## Q & A
